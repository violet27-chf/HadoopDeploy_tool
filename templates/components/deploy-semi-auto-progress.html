{% extends "base.html" %}

{% block title %}半自动部署进度 - Hadoop部署系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="bi bi-hourglass-split me-2"></i>半自动部署进度
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>半自动模式：</strong>系统将根据您的配置进行部署，部分步骤可能需要人工确认。
                    </div>
                    
                    <!-- 配置摘要 -->
                    <div id="configSummary" class="mb-4">
                        <h5>配置摘要</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Hadoop版本:</span>
                                        <span id="hadoopVersion">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Java版本:</span>
                                        <span id="javaVersion">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>NameNode主机:</span>
                                        <span id="namenodeHost">-</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>DataNode数量:</span>
                                        <span id="datanodeCount">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>副本因子:</span>
                                        <span id="replicationFactor">-</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>MapReduce内存:</span>
                                        <span id="mapReduceMemory">-</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 部署进度 -->
                    <div id="deployProgress" class="mb-4">
                        <h5>部署进度</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" style="width: 0%" id="progressBar">0%</div>
                        </div>
                        <div id="progressText" class="text-muted">准备开始部署...</div>
                    </div>

                    <!-- 部署步骤 -->
                    <div id="deploySteps" class="mb-4">
                        <h5>部署步骤</h5>
                        <div class="list-group">
                            <div class="list-group-item list-group-item-action" id="step1">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">1. 验证配置</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">验证用户配置的合理性</p>
                            </div>
                            <div class="list-group-item list-group-item-action" id="step2">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">2. 环境准备</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">准备部署环境，创建必要目录</p>
                            </div>
                            <div class="list-group-item list-group-item-action" id="step3">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">3. 安装组件</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">根据选择安装Hadoop和相关组件</p>
                            </div>
                            <div class="list-group-item list-group-item-action" id="step4">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">4. 应用配置</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">应用用户自定义的配置参数</p>
                            </div>
                            <div class="list-group-item list-group-item-action" id="step5">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">5. 启动服务</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">启动Hadoop集群服务</p>
                            </div>
                            <div class="list-group-item list-group-item-action" id="step6">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">6. 验证部署</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">验证集群运行状态和配置</p>
                            </div>
                        </div>
                    </div>
                    <!-- 部署日志 -->
                    <div id="deployLogs" class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-terminal-split me-2"></i>部署日志</h5>
                        <div class="log-card bg-dark text-light p-3 rounded shadow-sm border border-2 border-warning" style="max-height: 320px; overflow-y: auto; font-size:1.08rem;">
                            <pre id="logContent" class="mb-0 text-light" style="font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace; letter-spacing: 0.5px;">等待开始部署...</pre>
                        </div>
                    </div>

                    <!-- 用户确认区域 -->
                    <div id="userConfirmation" class="mb-4" style="display: none;">
                        <h5>需要用户确认</h5>
                        <div class="alert alert-info">
                            <div id="confirmationMessage"></div>
                            <div class="mt-3">
                                <button class="btn btn-success me-2" onclick="confirmAction()">
                                    <i class="bi bi-check-circle me-2"></i>确认
                                </button>
                                <button class="btn btn-danger" onclick="cancelAction()">
                                    <i class="bi bi-x-circle me-2"></i>取消
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-secondary" onclick="goBack()">
                            <i class="bi bi-arrow-left me-2"></i>返回
                        </button>
                        <button class="btn btn-warning" id="startDeploy" onclick="startSemiAutoDeploy()">
                            <i class="bi bi-play-fill me-2"></i>开始部署
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let deployInProgress = false;
let logTimer = null;

function goBack() {
    window.location.href = '/deploy/semiAutoConfig';
}

function loadConfigSummary() {
    const config = sessionStorage.getItem('semiAutoConfig');
    if (config) {
        const configData = JSON.parse(config);
        // 兼容嵌套结构
        const basic = configData.basic || {};
        const cluster = configData.cluster || {};
        document.getElementById('hadoopVersion').textContent = basic.hadoopVersion || '-';
        document.getElementById('javaVersion').textContent = basic.javaVersion || '-';
        document.getElementById('namenodeHost').textContent = basic.namenodeHost || '-';
        document.getElementById('datanodeCount').textContent = cluster.datanodeCount || '-';
        document.getElementById('replicationFactor').textContent = cluster.replicationFactor || '-';
        document.getElementById('mapReduceMemory').textContent = (cluster.mapReduceMemory || '-') + ' MB';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 校验服务器信息是否存在
    const serverConfig = sessionStorage.getItem('serverConfig');
    if (!serverConfig || serverConfig === '[]') {
        alert('未找到服务器配置信息，请先填写服务器信息！');
        window.location.href = '/deploy/start';
        return;
    }
    loadConfigSummary();
});

function updateSteps(steps) {
    for (let i = 0; i < steps.length; i++) {
        const stepDiv = document.getElementById('step' + (i + 1));
        if (!stepDiv) continue;
        let status = steps[i].status;
        let statusText = '';
        let statusClass = '';
        if (status === 'pending') {
            statusText = '等待中...';
            statusClass = '';
        } else if (status === 'doing') {
            statusText = '进行中...';
            statusClass = 'list-group-item-info';
        } else if (status === 'done') {
            statusText = '完成';
            statusClass = 'list-group-item-success';
        } else if (status === 'error') {
            statusText = '失败';
            statusClass = 'list-group-item-danger';
        }
        // 状态文字
        stepDiv.querySelector('small').textContent = statusText;
        // 高亮当前步骤
        stepDiv.className = 'list-group-item list-group-item-action ' + statusClass;
        // 失败时显示错误信息
        let errorMsg = steps[i].errorMsg || '';
        let errorDiv = stepDiv.querySelector('.step-error');
        if (status === 'error' && errorMsg) {
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'step-error text-danger mt-1';
                stepDiv.appendChild(errorDiv);
            }
            errorDiv.textContent = errorMsg;
        } else if (errorDiv) {
            errorDiv.remove();
        }
    }
}

function startSemiAutoDeploy() {
    if (deployInProgress) return;
    deployInProgress = true;
    document.getElementById('startDeploy').disabled = true;
    document.getElementById('startDeploy').innerHTML = '<i class="bi bi-hourglass-split me-2"></i>部署中...';
    // 获取配置
    const config = JSON.parse(sessionStorage.getItem('semiAutoConfig') || '{}');
    // 读取服务器信息并合并
    const servers = JSON.parse(sessionStorage.getItem('serverConfig') || '[]');
    config.servers = servers;
    fetch('/api/deploy/semi-auto/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config })
    }).then(res => res.json()).then(data => {
        pollSemiAutoStatus();
        if (!logTimer) {
            logTimer = setInterval(fetchLog, 1000);
        }
    }).catch(err => {
        alert('启动部署失败: ' + err.message);
    });
}

function pollSemiAutoStatus() {
    fetch('/api/deploy/semi-auto/status')
        .then(res => res.json())
        .then(data => {
            // 更新进度条
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = (data.progress || 0) + '%';
            progressBar.textContent = (data.progress || 0) + '%';
            // 优化进度条下方文字：下载阶段只显示"正在下载Hadoop..."，不显示详细进度
            let lastLog = data.log && data.log.length > 0 ? data.log[data.log.length - 1] : '准备开始部署...';
            if (lastLog.includes('下载进度')) {
                lastLog = '正在下载Hadoop...';
            }
            document.getElementById('progressText').textContent = lastLog;
            // 更新步骤
            if (data.steps) {
                updateSteps(data.steps);
            }
            // 部署完成后显示集群链接（显示在日志区下方）
            if (data.status === 'done' && data.cluster_links) {
                let html = '<div class="alert alert-success mt-3">集群部署完成！<br>Web UI 入口：';
                if (data.cluster_links.NameNode) {
                    html += `<br><a href="${data.cluster_links.NameNode}" target="_blank">NameNode管理界面</a>`;
                }
                if (data.cluster_links.ResourceManager) {
                    html += `<br><a href="${data.cluster_links.ResourceManager}" target="_blank">YARN ResourceManager</a>`;
                }
                html += '</div>';
                // 插入到日志区下方
                const logsDiv = document.getElementById('deployLogs');
                let old = document.getElementById('clusterLinks');
                if (old) old.remove();
                const div = document.createElement('div');
                div.id = 'clusterLinks';
                div.innerHTML = html;
                logsDiv.appendChild(div);
                document.getElementById('startDeploy').innerHTML = '<i class="bi bi-check-circle me-2"></i>部署完成';
                document.getElementById('startDeploy').classList.remove('btn-warning');
                document.getElementById('startDeploy').classList.add('btn-secondary');
                // 部署完成后停止日志刷新
                if (logTimer) {
                    clearInterval(logTimer);
                    logTimer = null;
                }
            } else if (data.status === 'error') {
                // 部署失败也停止日志刷新
                if (logTimer) {
                    clearInterval(logTimer);
                    logTimer = null;
                }
            }
            // 继续轮询
            if (data.status === 'running' || data.status === 'idle') {
                setTimeout(pollSemiAutoStatus, 1500);
            }
        });
}

// 实时日志自动刷新（仅在部署中启动）
function fetchLog() {
  fetch('/api/deploy/semi-auto/status')
    .then(res => res.json())
    .then(data => {
      const logPre = document.getElementById('logContent');
      if (data.log) {
        // 过滤掉包含"下载进度"的所有行（只保留如"正在下载Hadoop..."等关键步骤）
        const filtered = data.log.filter(line => {
          if (line.includes('下载进度')) {
            return false;
          }
          return true;
        });
        logPre.textContent = filtered.join('\n');
        // 自动滚动到底部
        const logCard = logPre.parentElement;
        if (logCard) {
          logCard.scrollTop = logCard.scrollHeight;
        }
      }
    });
}
</script>
<style>
.log-card {
  background: #181c24 !important;
  color: #e6eaf3 !important;
  border-radius: 1rem !important;
  border: 2px solid #ffc10733 !important;
  box-shadow: 0 4px 24px #ffc10711 !important;
  font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
  font-size: 1.08rem;
  padding: 1.2rem 1rem;
  max-height: 320px;
  overflow-y: auto;
  margin-bottom: 0;
}
.log-card pre {
  background: transparent !important;
  color: #e6eaf3 !important;
  border: none !important;
  box-shadow: none !important;
  margin-bottom: 0;
  font-size: 1.08rem;
  letter-spacing: 0.5px;
}
.log-card::-webkit-scrollbar {
  width: 8px;
  background: #23272e;
}
.log-card::-webkit-scrollbar-thumb {
  background: #3a3f4b;
  border-radius: 4px;
}
@media (max-width: 768px) {
  .log-card { font-size: 0.95rem; padding: 0.7rem 0.5rem; }
}
</style>
{% endblock %} 