{% extends "base.html" %}

{% block title %}全自动Hadoop部署 - Hadoop部署系统{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="mb-3 d-flex justify-content-end">
                <button class="btn btn-outline-primary" id="btnConfigYum" onclick="showConfigYumModal()">
                    <i class="bi bi-gear"></i> 配置yum源
                </button>
            </div>
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white d-flex align-items-center" style="border-top-left-radius: 1.2rem; border-top-right-radius: 1.2rem;">
                    <i class="bi bi-gear-fill me-2 fs-3"></i>
                    <h3 class="mb-0">全自动Hadoop集群部署</h3>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info d-flex align-items-center mb-4">
                        <i class="bi bi-info-circle me-2 fs-4"></i>
                        <div><strong>全自动模式：</strong>系统将自动完成所有配置步骤，无需人工干预。</div>
                    </div>
                    <hr>
                    <!-- 部署进度 -->
                    <div id="deployProgress" class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart-steps me-2"></i>部署进度</h5>
                        <div class="progress mb-3" style="height: 1.5rem;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary fs-6 fw-bold" 
                                 role="progressbar" style="width: 0%" id="progressBar">0%</div>
                        </div>
                        <div id="progressText" class="text-muted">准备开始部署...</div>
                    </div>
                    <!-- 部署步骤 -->
                    <div id="deploySteps" class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-list-ol me-2"></i>部署步骤</h5>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step1">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-search text-primary me-2"></i>1. 环境检测</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">连接服务器，检测环境，关闭防火墙</p>
                            </div>
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step2">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-cup-hot text-primary me-2"></i>2. 安装Java环境</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">安装和配置Java运行环境</p>
                            </div>
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step3">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-download text-primary me-2"></i>3. 下载Hadoop</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">下载并解压Hadoop安装包</p>
                            </div>
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step4">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-file-earmark-text text-primary me-2"></i>4. 配置Hadoop</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">自动配置Hadoop核心参数</p>
                            </div>
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step5">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-play-fill text-primary me-2"></i>5. 启动集群</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">启动Hadoop集群服务</p>
                            </div>
                            <div class="list-group-item list-group-item-action py-3 px-4" id="step6">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-semibold"><i class="bi bi-patch-check-fill text-primary me-2"></i>6. 验证部署</h6>
                                    <small class="text-muted">等待中...</small>
                                </div>
                                <p class="mb-1">验证集群运行状态</p>
                            </div>
                        </div>
                    </div>
                    <!-- 部署日志 -->
                    <div id="deployLogs" class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-terminal-split me-2"></i>部署日志</h5>
                        <div class="log-card bg-dark text-light p-3 rounded shadow-sm border border-2 border-primary" style="max-height: 320px; overflow-y: auto; font-size:1.08rem;">
                            <pre id="logContent" class="mb-0 text-light" style="font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace; letter-spacing: 0.5px;">等待开始部署...</pre>
                        </div>
                        <!-- 部署完成后显示Hadoop集群访问链接 -->
                        <div id="clusterLinks" class="mt-3"></div>
                    </div>
                    <!-- 操作按钮 -->
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary btn-lg px-4" onclick="goBack()">
                            <i class="bi bi-arrow-left me-2"></i>返回
                        </button>
                        <button class="btn btn-success btn-lg px-5" id="startDeploy" onclick="startAutoDeploy()">
                            <i class="bi bi-play-fill me-2"></i>开始自动部署
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 配置yum源弹窗 -->
<div class="modal fade" id="yumModal" tabindex="-1" aria-labelledby="yumModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="yumModalLabel">配置yum源</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="alert alert-info mb-0">将自动对所有已配置服务器批量操作，无需手动输入服务器信息。</div>
        </div>
        <div id="yumProgressArea" class="mt-3" style="min-height:2.5em;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="configYumRepo()">确定</button>
      </div>
    </div>
  </div>
</div>
<style>
.log-card {
  background: #181c24 !important;
  color: #e6eaf3 !important;
  border-radius: 1rem !important;
  border: 2px solid #0d6efd33 !important;
  box-shadow: 0 4px 24px #0d6efd11 !important;
  font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
  font-size: 1.08rem;
  padding: 1.2rem 1rem;
  max-height: 320px;
  overflow-y: auto;
  margin-bottom: 0;
}
.log-card pre {
  background: transparent !important;
  color: #e6eaf3 !important;
  border: none !important;
  box-shadow: none !important;
  margin-bottom: 0;
  font-size: 1.08rem;
  letter-spacing: 0.5px;
}
.log-card::-webkit-scrollbar {
  width: 8px;
  background: #23272e;
}
.log-card::-webkit-scrollbar-thumb {
  background: #3a3f4b;
  border-radius: 4px;
}
@media (max-width: 768px) {
  .log-card { font-size: 0.95rem; padding: 0.7rem 0.5rem; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let deployInProgress = false;

function updateSteps(steps) {
    for (let i = 0; i < steps.length; i++) {
        const stepDiv = document.getElementById('step' + (i + 1));
        if (!stepDiv) continue;
        let status = steps[i].status;
        let statusText = '';
        let statusClass = '';
        if (status === 'pending') {
            statusText = '等待中...';
            statusClass = '';
        } else if (status === 'doing') {
            statusText = '进行中...';
            statusClass = 'active border-primary';
        } else if (status === 'done') {
            statusText = '已完成';
            statusClass = 'list-group-item-success';
        } else if (status === 'error') {
            statusText = '失败';
            statusClass = 'list-group-item-danger';
        }
        // 设置状态文本
        stepDiv.querySelector('small').textContent = statusText;
        // 设置高亮样式
        stepDiv.className = 'list-group-item list-group-item-action py-3 px-4 ' + statusClass;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 自动从URL参数写入sessionStorage，兼容URL跳转
    const urlParams = new URLSearchParams(window.location.search);
    const configParam = urlParams.get('config');
    if (configParam) {
        sessionStorage.setItem('serverConfig', configParam);
    }
    // 原有校验逻辑
    const config = sessionStorage.getItem('serverConfig');
    if (!config) {
        alert('未找到服务器配置信息，请返回重新配置');
        window.location.href = '/';
    }
});

function goBack() {
    window.location.href = '/deploy/method';
}

function startAutoDeploy() {
    if (deployInProgress) return;
    deployInProgress = true;
    document.getElementById('startDeploy').disabled = true;
    document.getElementById('startDeploy').innerHTML = '<i class="bi bi-hourglass-split me-2"></i>部署中...';

    // 清空日志
    document.getElementById('logContent').textContent = '正在启动部署...\n';

    // 获取服务器配置
    let config = sessionStorage.getItem('serverConfig');
    try {
        config = JSON.parse(config);
    } catch (e) {
        alert('服务器配置信息格式错误');
        return;
    }
    if (!config) {
        alert('未找到服务器配置信息');
        return;
    }

    fetch('/api/deploy/auto/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({config: config})
    }).then(res => res.json()).then(data => {
        if (data.msg) {
            addLog(data.msg);
        }
        pollDeployStatus();
    }).catch(err => {
        addLog('启动部署失败: ' + err.message);
        alert('启动部署失败');
    });
}

function addLog(message) {
    const logElement = document.getElementById('logContent');
    const timestamp = new Date().toLocaleTimeString();
    logElement.textContent += `[${timestamp}] ${message}\n`;
    logElement.scrollTop = logElement.scrollHeight;
}

function pollDeployStatus() {
    fetch('/api/deploy/auto/status')
        .then(res => res.json())
        .then(data => {
            // 更新进度条
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = (data.progress || 0) + '%';
            progressBar.textContent = (data.progress || 0) + '%';
            // 更新进度文本
            document.getElementById('progressText').textContent = data.log && data.log.length > 0 ? data.log[data.log.length - 1] : '准备开始部署...';
            // 更新日志
            if (data.log) {
                document.getElementById('logContent').textContent = data.log.map((msg, idx) => `[${idx+1}] ${msg}`).join('\n');
                document.getElementById('logContent').scrollTop = document.getElementById('logContent').scrollHeight;
            }
            // 更新步骤
            if (data.steps) {
                updateSteps(data.steps);
            }
            // 部署完成后显示集群链接
            if (data.status === 'done' && data.cluster_links) {
                let html = '<div class="alert alert-success">集群部署完成！<br>Web UI 入口：';
                if (data.cluster_links.NameNode) {
                    html += `<br><a href="${data.cluster_links.NameNode}" target="_blank">NameNode管理界面</a>`;
                }
                if (data.cluster_links.ResourceManager) {
                    html += `<br><a href="${data.cluster_links.ResourceManager}" target="_blank">YARN ResourceManager</a>`;
                }
                html += '</div>';
                document.getElementById('clusterLinks').innerHTML = html;
                document.getElementById('startDeploy').innerHTML = '<i class="bi bi-check-circle me-2"></i>部署完成';
                document.getElementById('startDeploy').classList.remove('btn-success');
                document.getElementById('startDeploy').classList.add('btn-secondary');
            } else if (data.status === 'error') {
                document.getElementById('startDeploy').innerHTML = '<i class="bi bi-x-circle me-2"></i>部署失败';
                document.getElementById('startDeploy').classList.remove('btn-success');
                document.getElementById('startDeploy').classList.add('btn-danger');
            }
            // 继续轮询
            if (data.status === 'running' || data.status === 'idle') {
                setTimeout(pollDeployStatus, 1500);
            }
        });
}

function showConfigYumModal() {
    var modal = new bootstrap.Modal(document.getElementById('yumModal'));
    modal.show();
}

function configYumRepo() {
    let servers = sessionStorage.getItem('serverConfig');
    try {
        servers = JSON.parse(servers);
    } catch (e) {
        alert('服务器配置信息格式错误');
        return;
    }
    if (!servers || !Array.isArray(servers) || servers.length === 0) {
        alert('未找到服务器配置信息');
        return;
    }
    // 显示进度
    const progressArea = document.getElementById('yumProgressArea');
    progressArea.innerHTML = '<div class="text-info"><i class="bi bi-arrow-repeat me-2"></i>正在批量配置yum源，请稍候...</div>';
    fetch('/api/yum/configure', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ servers })
    })
    .then(res => res.json())
    .then(data => {
        if (data.results && Array.isArray(data.results)) {
            let html = '<ul class="list-group">';
            data.results.forEach(r => {
                html += `<li class='list-group-item d-flex justify-content-between align-items-center'>
                    <span>${r.host}</span>
                    <span>${r.success ? '<span class=\'text-success\'>成功</span>' : '<span class=\'text-danger\'>失败</span>'} ${r.msg ? ('<small class=\'ms-2\'>' + r.msg + '</small>') : ''}</span>
                </li>`;
            });
            html += '</ul>';
            progressArea.innerHTML = html;
        } else {
            progressArea.innerHTML = '<div class="text-danger">未获取到服务器返回结果</div>';
        }
        if (data.success) {
            setTimeout(() => {
                var modal = bootstrap.Modal.getInstance(document.getElementById('yumModal'));
                if (modal) modal.hide();
            }, 1800);
        }
    })
    .catch(err => {
        progressArea.innerHTML = '<div class="text-danger">请求失败: ' + err + '</div>';
    });
}

// 实时日志自动刷新
function fetchLog() {
  fetch('/api/log')
    .then(res => res.text())
    .then(log => {
      const logPre = document.getElementById('logContent');
      logPre.textContent = log;
      // 自动滚动到底部（滚动 log-card 容器）
      const logCard = logPre.parentElement;
      if (logCard) {
        logCard.scrollTop = logCard.scrollHeight;
      }
    });
}
setInterval(fetchLog, 1000); // 每秒刷新一次
</script>
{% endblock %} 